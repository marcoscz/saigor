@page "/tarefas/edit/{id:int}"
@using MudBlazor
@inject ITarefaRepository TarefaRepository
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-3">
    <MudCard>
        <MudCardHeader>
            <MudText Typo="Typo.h5">Editar Tarefa</MudText>
        </MudCardHeader>
        <MudCardContent>
            @if (isLoading)
            {
                <div class="d-flex align-center justify-center">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                    <MudText Class="ml-4">Carregando...</MudText>
                </div>
            }
            else
            {
                <TarefaForm Tarefa="@tarefa" IsProcessing="@isProcessing" OnValidSubmit="SalvarAsync" OnCancel="Cancelar" />
            }
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    [Parameter] public int id { get; set; }
    private TarefaModel tarefa = new();
    private bool isLoading = true;
    private bool isProcessing;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        try
        {
            var found = (await TarefaRepository.GetAllAsync()).FirstOrDefault(t => t.Id == id);
            if (found is not null)
                tarefa = found;
            else
            {
                Snackbar.Add("Tarefa n√£o encontrada.", Severity.Error);
                Navigation.NavigateTo("/tarefas");
                return;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar tarefa: {ex.Message}", Severity.Error);
            Navigation.NavigateTo("/tarefas");
            return;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SalvarAsync()
    {
        if (isProcessing) return;
        try
        {
            isProcessing = true;
            TarefaRepository.Update(tarefa);
            await TarefaRepository.SaveChangesAsync();
            Snackbar.Add("Tarefa salva com sucesso!", Severity.Success);
            Navigation.NavigateTo("/tarefas");
        }
        catch (Exception ex)
        {
            var message = ex.InnerException != null ? $"{ex.Message} | {ex.InnerException.Message}" : ex.Message;
            Snackbar.Add($"Erro ao salvar a tarefa: {message}", Severity.Error);
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void Cancelar()
    {
        if (!isProcessing)
            Navigation.NavigateTo("/tarefas");
    }
} 